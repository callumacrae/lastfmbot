var net = require('net');

function IRC(config)
{
	var __self = this;
	this.socket = new net.Socket();

	this.socket.on('data', function(data) {
		data = data.split('\r\n');
		for (var i = 0; i < data.length; i++) {
			if (data !== '') {
				__self.handle(data[i]);
			}
		}
	});

	this.socket.on('error', function(exception) {
		console.log('Error: ', exception);
	});

	this.socket.on('connect', function() {
		console.log('Established connection, registering and shit...');
		__self.on(/^PING :(.+)$/i, function(info) {
			__self.raw('PONG :' + info[1]);
		});
		setTimeout(function() {
			__self.raw('NICK ' + config.user.nick);
			__self.raw('USER ' + config.user.user + ' 8 * :' + config.user.real);
			setTimeout(function() {
				for (var i = 0; i < config.chans.length; i++) {
					__self.raw('JOIN ' + config.chans[i]);
				}
			}, 20000);
		}, 1000);
	});

	this.socket.setEncoding('ascii');
	this.socket.setNoDelay();
	this.socket.connect(config.server.port, config.server.addr);

	//handles incoming messages
	this.handle = function(data) {
		var i, info;
		for (i = 0; i < listeners.length; i++) {
			info = listeners[i][0].exec(data);
			if (info) {
				listeners[i][1](info, data);
				if (listeners[i][2]) {
					listeners.splice(i, 1);
				}
			}
		}
	}

	this.raw = function(data) {
		__self.socket.write(data + '\n', 'ascii');
	}

	listeners = [];
	this.on = function(data, callback) {
		listeners.push([data, callback, false])
	}
	this.on_once = function(data, callback) {
		listeners.push([data, callback, true]);
	}
}

module.exports = IRC;